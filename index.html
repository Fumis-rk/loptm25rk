<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ranking Liga Oeste Paulista de T√™nis de Mesa 2025</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
</head>
<body class="bg-gray-100 text-gray-900 flex flex-col min-h-screen">
  <div id="root" class="flex-grow"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    function App() {
      const [data, setData] = useState([]);
      const [categorias, setCategorias] = useState([]);
      const [categoriaSelecionada, setCategoriaSelecionada] = useState("");
      const [atletaSelecionado, setAtletaSelecionado] = useState(null);

      useEffect(() => {
        Papa.parse("rankingloptm.csv", {
          download: true,
          header: true,
          complete: (results) => {
            const rows = results.data.filter(row => row["Nome"]);
            setData(rows);
            const cats = [...new Set(rows.map(row => row["Categoria/Classe"]).filter(Boolean))];
            setCategorias(cats.sort());
          },
        });
      }, []);

      const atletas = data.filter(d => d["Categoria/Classe"] === categoriaSelecionada);

      const parseNum = (v) => {
        if (v == null) return 0;
        let s = String(v).trim();
        if (s === "") return 0;
        s = s.replace(/\./g, '');
        s = s.replace(',', '.');
        const n = parseFloat(s);
        return isNaN(n) ? 0 : n;
      };

      const gerarPDF = () => {
        if (!data || data.length === 0) {
          alert("CSV ainda n√£o carregado.");
          return;
        }

        const hoje = new Date();
        const dataGeracao = hoje.toLocaleDateString("pt-BR") + " " + hoje.toLocaleTimeString("pt-BR");

        const montarTabela = (rows) => {
          const headers = ["#", "Nome", "Equipe", "Categoria", "Pontos"];
          const body = [];
          body.push(headers.map(h => ({ text: h, style: "tableHeader" })));
          rows.forEach((row, i) => {
            const fill = i % 2 === 0 ? "#f9f9f9" : null;
            const rank = i + 1;
            body.push([
              { text: String(rank), alignment: "center", fillColor: fill },
              { text: row["Nome"] || "", fillColor: fill },
              { text: row["Equipe"] || "", fillColor: fill },
              { text: row["Categoria/Classe"] || "", alignment: "center", fillColor: fill },
              { text: row["Pontos"] || "", alignment: "right", fillColor: fill }
            ]);
          });
          return { table: { headerRows: 1, widths: ["auto","3*","3*","2*","auto"], body }, layout: {
            fillColor: (rowIndex)=>rowIndex===0?"#1e40af":null,
            hLineColor: ()=>"#aaa",
            vLineColor: ()=>"#aaa"
          }};
        };

        try {
          let content = [
            { text: "Ranking LOPTM 2025", style: "header", alignment: "center" },
            { text: `Gerado em: ${dataGeracao}`, style: "subheader", alignment: "center", margin:[0,0,0,10] }
          ];

          if (categoriaSelecionada) {
            let rows = data.filter(d=>d["Categoria/Classe"]===categoriaSelecionada && d["Nome"]);
            rows = rows.sort((a,b)=>parseNum(b["Pontos"])-parseNum(a["Pontos"]));
            content.push({ text: `Categoria: ${categoriaSelecionada}`, style: "catHeader", margin:[0,8,0,4] });
            content.push(montarTabela(rows));
          } else {
            const cats = [...new Set(data.map(r=>r["Categoria/Classe"]).filter(Boolean))].sort();
            cats.forEach(cat=>{
              let rows = data.filter(d=>d["Categoria/Classe"]===cat && d["Nome"]);
              rows = rows.sort((a,b)=>parseNum(b["Pontos"])-parseNum(a["Pontos"]));
              if (rows.length===0) return;
              content.push({ text: cat, style: "catHeader", margin:[0,8,0,4] });
              content.push(montarTabela(rows));
            });
          }

          const docDefinition = {
            pageSize:"A4",
            pageOrientation:"portrait",
            content,
            styles: {
              header:{fontSize:18,bold:true,margin:[0,0,0,6]},
              subheader:{fontSize:10,italics:true,margin:[0,0,0,10]},
              catHeader:{fontSize:14,bold:true,color:"#1e40af"},
              tableHeader:{bold:true,color:"white",alignment:"center"}
            },
            defaultStyle:{fontSize:10}
          };

          // abre PDF em nova aba
          pdfMake.createPdf(docDefinition).open();

        } catch(err) {
          console.error(err);
          alert("Erro ao gerar PDF. Veja o console.");
        }
      };

      return (
        <div className="container mx-auto p-4 flex flex-col">
          <img src="logo.png" alt="Logo LOPTM" className="block mx-auto h-24 mb-4" />
          <h1 className="text-3xl font-bold text-blue-700 mb-2 text-center">Ranking LOPTM 2025</h1>
          <p className="text-gray-700 text-center mt-2 mb-4">Clique no nome do atleta para mais detalhes</p>

          <div className="mb-6 flex justify-center">
            <select
              className="p-2 border rounded-lg shadow"
              value={categoriaSelecionada}
              onChange={(e)=>{setCategoriaSelecionada(e.target.value); setAtletaSelecionado(null);}}
            >
              <option value="">Selecione uma Categoria</option>
              {categorias.map((c,i)=>(<option key={i} value={c}>{c}</option>))}
            </select>
          </div>

          {categoriaSelecionada && !atletaSelecionado && (
            <table className="min-w-full bg-white rounded-lg shadow overflow-hidden">
              <thead className="bg-blue-700 text-white">
                <tr>
                  <th className="py-2 px-4">#</th>
                  <th className="py-2 px-4">Nome</th>
                  <th className="py-2 px-4">Equipe</th>
                  <th className="py-2 px-4">Categoria</th>
                  <th className="py-2 px-4">Pontos</th>
                </tr>
              </thead>
              <tbody>
                {atletas.sort((a,b)=>parseNum(b["Pontos"])-parseNum(a["Pontos"])).map((atleta,index)=>(
                  <tr key={index} className="border-b hover:bg-gray-100 cursor-pointer" onClick={()=>setAtletaSelecionado(atleta)}>
                    <td className="py-2 px-4">{index+1}</td>
                    <td className="py-2 px-4">{atleta["Nome"]}</td>
                    <td className="py-2 px-4">{atleta["Equipe"]}</td>
                    <td className="py-2 px-4">{atleta["Categoria/Classe"]}</td>
                    <td className="py-2 px-4">{atleta["Pontos"]}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          )}

          {atletaSelecionado && (
            <div className="bg-white p-6 rounded-lg shadow mt-6">
              <button className="mb-4 px-4 py-2 bg-gray-300 rounded" onClick={()=>setAtletaSelecionado(null)}>‚Üê Voltar</button>
              <h2 className="text-2xl font-bold text-blue-700 mb-2">{atletaSelecionado["Nome"]}</h2>
              <p className="text-gray-700 mb-2"><b>Equipe:</b> {atletaSelecionado["Equipe"]}</p>
              <p className="text-gray-700 mb-2"><b>Categoria:</b> {atletaSelecionado["Categoria/Classe"]}</p>
              <p className="text-lg font-bold text-gray-900 mb-4">Total de Pontos: {atletaSelecionado["Pontos"]}</p>

              <h3 className="text-xl font-semibold mb-2">Etapas</h3>
              <ul className="list-disc ml-6">
                {Object.keys(atletaSelecionado).filter(k=>k.startsWith("Etapa")||k.includes("ETAPA")).map((etapa,i)=>(
                  <li key={i}>{etapa}: {atletaSelecionado[etapa]||0}</li>
                ))}
              </ul>
            </div>
          )}

          <div className="mt-6 flex justify-center mb-4">
            <button onClick={gerarPDF} className="px-4 py-2 bg-blue-400 text-white rounded-lg shadow hover:bg-blue-500 transition">
              üìÑ Baixar Ranking em PDF
            </button>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>

